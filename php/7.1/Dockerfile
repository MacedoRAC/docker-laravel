FROM php:7.1-fpm-stretch

ENV PROJECT_PATH=.

RUN  dpkg --configure -a

RUN apt-get update -y && apt-get install -y \
        $PHPIZE_DEPS \
        curl \
        libcurl3-dev \
        libtool \
        libxml2 \
        libpng-dev \
        libpq-dev \
        locales \
        tzdata \
        git \
        autoconf \
        g++ \
        libtool \
        make \
        gcc \
        libc-dev \
        pkg-config \
        libmagickwand-dev \
        libfreetype6-dev \
        libjpeg62-turbo-dev \
        libmcrypt-dev \
        mysql-client

RUN apt-get autoremove

RUN pecl install imagick

RUN docker-php-ext-enable imagick \
    && docker-php-ext-configure gd \
        --with-gd \
        --with-freetype-dir=/usr/include/ \
        --with-png-dir=/usr/include/ \
        --with-jpeg-dir=/usr/include/ \
    && NPROC=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || 1) \
    && docker-php-ext-install \
        -j${NPROC} gd \
        curl \
        iconv \
        mbstring \
        mcrypt \
        pdo \
        pdo_mysql \
        pcntl \
        tokenizer \
        xml \
        zip \
        soap \
        intl

RUN curl -s https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin/ --filename=composer

RUN apt-get autoremove


RUN echo "tzdata tzdata/Areas select Europe" > timezone.txt
RUN echo "tzdata tzdata/Zones/Europe select Lisbon" >> timezone.txt
COPY timezone.* /
RUN debconf-set-selections timezone.txt
RUN rm /etc/timezone
RUN rm /etc/localtime
RUN dpkg-reconfigure -f noninteractive tzdata

COPY auth.* /root/.composer/

ENV COMPOSER_HOME=/root/.composer


WORKDIR /var/www/


ENTRYPOINT ["./entrypoint.sh"]